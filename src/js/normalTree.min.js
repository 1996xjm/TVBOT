import{getNodeHeight,MainTree,maxLength}from"/static/xiaochiPlot/minJS/mainTree.min.js";import{BarPlot}from"/static/xiaochiPlot/js/barPlot.js";import{splitPath}from"/static/xiaochiPlot/js/splitPath.js";class NormalTree extends MainTree{constructor(){super("treefile"),this.barPlot=new BarPlot(this),this.plotType="normalTree",this.creatVueApp()}init(t,a,e){if(console.log("树枝排序",t,a,e),"attrChanged"==t&&"Branches sorting"==e||"originalJsonData"==t)return console.log(this.styleData),void this.reRootTree(this.styleData.rootNodeIndex,this.styleData.rootOffsetRate);"attrChanged"==t&&"data-source"==a&&"Bootstraps"==e&&(e=(e=this.figureData.branches.Bootstraps["data-source"]).optionList[e.value],console.log(99999,e),e in this.btRangeDict?(console.log(this.btRangeDict[e]),this.figureData.branches.Bootstraps.from.value=this.btRangeDict[e][0],this.figureData.branches.Bootstraps.to.value=this.btRangeDict[e][1]):(this.figureData.branches.Bootstraps.from.value=0,this.figureData.branches.Bootstraps.to.value=0),this.Vue.$refs.controlPlane.$forceUpdate()),this.zoomG.text("");super.init(),this.root=d3.cluster().size([this.innerHeight,this.innerwidth]).separation((t,a)=>2)(this.treeHierarchy),null!=this.rootLength&&this.figureData.branches.Branches["show-root"].value?this.root.data.length=this.rootLength:this.root.data.length=0,this.treeScale=parseFloat(this.innerwidth)/parseFloat(maxLength(this.root.data)),this.setBranchLength(this.root,0,this.treeScale,getNodeHeight(this.root),getNodeHeight(this.root)+1),this.maxLength=this.innerwidth,console.log("this.root：",this.root),console.log("maxLength：",maxLength(this.root.data)),this.drawLengthAxis(),this.geologicTimeScale(),this.drawTree(),this.drawNodeAges("normal"),this.drawCollapseClade(),this.drawTextBlock(),this.drawSymbol(),this.drawBarPlot(),this.drawBaseBarPlot(),this.drawBaseLollipopPlot(),this.drawBaseLollipopPlotCategory(),this.drawLinks(),this.drawHeatmap(),this.drawStackedBarPlot(),this.drawBoxPlot(),this.drawBoxPlotCategory(),this.drawPieChart(),this.drawBranchPieChart("normal"),this.drawBinary(),this.drawBinary2(),this.drawBubblePlot(),this.drawTextLabel(),this.drawTextLabelCategory(),this.drawBranchTextLabel("normal"),this.colorBranch(),this.drawRecombinationFragmentMap(),this.drawLegend(),this.setGlobalFontStyle()}drawTree(){const o=this;console.log("link",this.root.links());let a=this.figureData.branches.Branches,t=this.root.links();t.push({source:{branchLength:0,x:this.root.x},target:this.root});this.maingroup.append("g").selectAll("path").data(t).join("path").attr("class",a.id).attr("stroke",a.stroke.value).attr("fill","none").attr("d",t=>{var a=this.figureData.branches.Branches["link-type"];return this.linkHorizontal(t,a.optionList[a.value])}).call(t=>{this.renderAttr(t,a)}).on("click",this.treeBranchClickFunction()).on("touchstart",this.treeBranchClickFunction()).on("mouseenter",this.treeBranchEnterFunction()).on("mouseleave",this.treeBranchleaveFunction());let l=this.maingroup.selectAll("mytext").data(this.root.descendants()).join("g").attr("transform",t=>`translate(${t.branchLength},${t.x})`),e=this.figureData.leaves["Leaves Extension"].extension.value;e&&l.filter(t=>!t.children).append("path").attr("class",this.figureData.leaves["Leaves Extension"].id).attr("d",t=>`M0,0L${this.maxLength-t.branchLength},0`).call(t=>{this.renderAttr(t,this.figureData.leaves["Leaves Extension"])});var r=this.figureData.branches.Bootstraps.type;let n=r.optionList[r.value];var i=this.figureData.branches.Bootstraps["data-source"];let s=i.optionList[i.value],c=this.Vue.$refs.controlPlane.$data.controlList[0];r=c.findIndex(t=>"BT legend"==t.tabName),i=c.findIndex(t=>"BT color bar legend"==t.tabName);if(this.figureData.branches.Bootstraps.switch.value&&"None"!=s||(n="None",c[r].isDisplay=!1,c[i].isDisplay=!1),"text"==n&&(c[r].isDisplay=!1,c[i].isDisplay=!1,l.filter(t=>t.children).each(function(t,a){let e=d3.select(this);console.log(t);let l=o.figureData.branches.Bootstraps,r=0;"bootstrap"==s&&"btArr"in t.data?r=t.data.btArr[0]:s in o.btRangeDict&&"otherProperty_L"in t.data&&(r=t.data.otherProperty_L[s]),r>=l.from.value&&r<=l.to.value&&(r*=l["scale-by-factor"].value,r=Number(r.toFixed(10)),t=0==l["round-decimals"].value&&r<1?r:d3.format(`.${l["round-decimals"].value}f`)(r),e.selectAll("BTG").data([o.btDragData[a]]).join("g").attr("transform",t=>`translate(${t.x},${t.y})`).call(o.drag()).append("text").attr("class",l.id).text(0!=t?t:"").call(t=>{o.renderAttr(t,l)}))})),"circle"==n&&(c[r].isDisplay=!0,c[i].isDisplay=!1,l.filter(t=>t.children&&70<=t.data.name).append("g").append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("stroke-width",2).attr("fill",t=>90<t.data.name?"black":70<=t.data.name&&t.data.name<=90?"#aaaaaa":void 0).attr("opacity",t=>70<=t.data.name?1:0)),"gradient color circle"==n){c[r].isDisplay=!1,c[i].isDisplay=!0;r=this.figureData["BT color bar legend"]["ColorBar range"];let t=[...this.btRangeDict[s]];i=r["max-value"].value;""!=i&&(t[1]=Number(i));i=r["min-value"].value;""!=i&&(t[0]=Number(i)),this.mmvBTvalue=t;let e=d3.scaleSequential(r.reverse.value?[t[1],t[0]]:t,d3[this.styleData.currentColorInterpolate]);r["median-value"].value&&(i=Number(r["median-value"].value),e=d3.scaleSequential(r.reverse.value?[t[1],i,t[0]]:[t[0],i,t[1]],d3[this.styleData.currentColorInterpolate])),l.filter(t=>{let a=0;return"bootstrap"==s&&"btArr"in t.data&&0<t.data.btArr.length?a=t.data.btArr[0]:s in o.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[s]),t.children&&0!=a}).append("g").append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("stroke-width",1).attr("stroke","#000000").attr("fill",t=>{let a=0;return"bootstrap"==s&&"btArr"in t.data?a=t.data.btArr[0]:s in o.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[s]),e(a)})}let h=o.figureData.leaves["Text style"]["word-italic"].value,d=[];try{d=h.split(",")}catch(t){}console.log(d);let u=o.layerPlaneData.layerStatistic["word italic"];u=u&&u[0];let g=this.figureData.leaves["Text style"].x.value;l.filter(t=>!t.children).append("g").attr("transform",t=>{var a=t.data.isCollapse&&!this.figureData.branches.Branches["ignore-length"].value?t.data.lengthMMV[1]*this.treeScale:0;return`translate(${(e?this.maxLength-t.branchLength:a)+g},0)`}).append("text").attr("dy",".31em").attr("class",this.figureData.leaves["Text style"].id).call(t=>{this.drawLeafText(t)})}drawCollapseClade(){let t=this.root.leaves();var a=t.filter(t=>t.data.isCollapse);let l=this.innerHeight/t.length/2,e=this.figureData.branches.Branches;this.maingroup.append("g").selectAll("cladePath").data(a).join("path").attr("class",e.id).attr("d",t=>{var a=t.data.lengthMMV,e=this.innerHeight/getNodeHeight(this.root);return this.figureData.branches.Branches["ignore-length"].value?`M${t.branchLength-e},${t.x}L${t.branchLength},${t.x-l}L${t.branchLength},${t.x+l}Z`:`M${t.branchLength},${t.x}L${t.branchLength+a[0]*this.treeScale},${t.x-l}L${t.branchLength+a[1]*this.treeScale},${t.x+l}Z`}).attr("fill-opacity",t=>this.figureData["folded clade"]["Clade style"]["fill-opacity"].value).attr("fill",t=>(this.figureData["folded clade"]["Custom color"].switch.value?this.figureData["folded clade"]["Custom color"][t.data.name]:this.figureData["folded clade"]["Clade style"].fill).value).attr("stroke",e.stroke.value).call(t=>{this.renderAttr(t,e)}).on("mouseenter",this.treeBranchEnterFunction("foldedClade")).on("mouseleave",this.treeBranchleaveFunction("foldedClade")).on("click",this.treeBranchClickFunction("foldedClade")).on("touchstart",this.treeBranchClickFunction("foldedClade"))}drawBarPlot(){let t=this.layerPlaneData.layerStatistic["bar plot with category"]||[];t.forEach((s,t)=>{if(s.isShowObj.isShow){var c=this.layerDataDict[s.layerDataFlieKey].dataSource;let a=this.layerDataDict[s.layerDataFlieKey].dataIndex,e=c.columns[s.layerDataColumnsIndex[1]],l=c.columns[s.layerDataColumnsIndex[0]];var[h,d]=d3.extent(c,t=>t[e]),c=s.controlData.canvas["Canvas scale"].width.value;let r=this.innerHeight/this.root.leaves().length*(1-s.controlData.bar["Bar style"].padding.value);h=d3.scaleLinear().domain(h<0?[h,d]:[0,d]).range([0,c]);let t=this.root.leaves().filter(t=>a.has(t.data.name)&&a.get(t.data.name)[e]);d=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(s.controlData,d,h);let o=d3.scaleOrdinal().domain(s.categoryList).range(s.categoryColorList);s.controlData.bar["Custom color"].switch.value&&(c=s.categoryList.map(t=>s.controlData.bar["Custom color"][t].value),console.log(c),o.range(c)),s.colorScale=o;let n={},i=t.map(t=>(n[t.data.name]=t.x-r/2,{innerScaleKey:t.data.name,value:a.get(t.data.name)[e],colorScaleKey:a.get(t.data.name)[l]}));i.barStyle=s.controlData.bar["Bar style"],i.textStyle=s.controlData.bar["Bar text"],i.initType=null,i.innerScale=t=>n[t],i.innerScale.bandwidth=()=>r,i.colorScale=o,i.valueScale=h,this.barPlot.drawHorizontalBar1(d,i)}})}drawBaseBarPlot(){let t=this.layerPlaneData.layerStatistic["base bar plot"]||[];t.forEach((n,t)=>{if(n.isShowObj.isShow){var i=this.layerDataDict[n.layerDataFlieKey].dataSource;let a=this.layerDataDict[n.layerDataFlieKey].dataIndex,e=i.columns[n.layerDataColumnsIndex[0]];var[s,c]=d3.extent(i,t=>t[e]),i=n.controlData.canvas["Canvas scale"].width.value;let l=this.innerHeight/this.root.leaves().length*(1-n.controlData.bar["Bar style"].padding.value);c=d3.scaleLinear().domain(s<0?[s,c]:[0,c]).range([0,i]);let t=this.root.leaves().filter(t=>a.has(t.data.name)&&a.get(t.data.name)[e]);i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(n.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(n.controlData,i,c);d3.scaleOrdinal().domain(n.categoryList).range(n.categoryColorList);let r={},o=t.map(t=>(r[t.data.name]=t.x-l/2,{innerScaleKey:t.data.name,value:a.get(t.data.name)[e],colorScaleKey:t.data.name}));o.barStyle=n.controlData.bar["Bar style"],o.textStyle=n.controlData.bar["Bar text"],o.initType=null,o.innerScale=t=>r[t],o.innerScale.bandwidth=()=>l,o.colorScale=()=>n.controlData.bar["Bar style"].fill.value,o.valueScale=c,this.barPlot.drawHorizontalBar1(i,o)}})}drawBaseLollipopPlot(){let t=this.layerPlaneData.layerStatistic["base lollipop plot"]||[];t.forEach((s,t)=>{if(s.isShowObj.isShow){var c=this.layerDataDict[s.layerDataFlieKey].dataSource;let a=this.layerDataDict[s.layerDataFlieKey].dataIndex,e=c.columns[s.layerDataColumnsIndex[0]],[t,l]=d3.extent(c,t=>t[e]);var h=s.controlData.canvas["Canvas scale"].width.value;let r=this.innerHeight/this.root.leaves().length;var d=d3.scaleLinear().domain(t<0?[t,l]:[0,l]).range([0,h]);let o=this.root.leaves().filter(t=>a.has(t.data.name)&&a.get(t.data.name)[e]);c=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(s.controlData,c,d);d3.scaleOrdinal().domain(s.categoryList).range(s.categoryColorList);let n={},i=o.map(t=>(n[t.data.name]=t.x-r/2,{innerScaleKey:t.data.name,value:a.get(t.data.name)[e],colorScaleKey:t.data.name}));h=d3.scaleLinear().domain([t,l].map(t=>t<0?0:t)).range([s.controlData.lollipop["Lollipop size"]["min-radius"].value,s.controlData.lollipop["Lollipop size"]["max-radius"].value]);i.barStyle=s.controlData.lollipop["Lollipop style"],i.textStyle=s.controlData.lollipop["Lollipop text"],i.lineStyle=s.controlData.lollipop["Line style"],s.controlData.lollipop["Lollipop size"].switch.value?(i.rScale=h,s.controlData.lollipop["Lollipop style"].r.isSvgAttr=!1):s.controlData.lollipop["Lollipop style"].r.isSvgAttr=!0,i.initType=null,i.innerScale=t=>n[t],i.innerScale.bandwidth=()=>r,i.colorScale=()=>s.controlData.lollipop["Lollipop style"].fill.value,i.valueScale=d,this.barPlot.drawHorizontalLollipop(c,i)}})}drawBaseLollipopPlotCategory(){let t=this.layerPlaneData.layerStatistic["lollipop plot with category"]||[];t.forEach((h,t)=>{if(h.isShowObj.isShow){var d=this.layerDataDict[h.layerDataFlieKey].dataSource;let a=this.layerDataDict[h.layerDataFlieKey].dataIndex,e=d.columns[h.layerDataColumnsIndex[1]],l=d.columns[h.layerDataColumnsIndex[0]],[t,r]=d3.extent(d,t=>t[e]);var u=h.controlData.canvas["Canvas scale"].width.value;let o=this.innerHeight/this.root.leaves().length;d=d3.scaleLinear().domain(t<0?[t,r]:[0,r]).range([0,u]);let n=this.root.leaves().filter(t=>a.has(t.data.name)&&a.get(t.data.name)[e]);u=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(h.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(h.controlData,u,d);let i=d3.scaleOrdinal().domain(h.categoryList).range(h.categoryColorList);h.controlData.lollipop["Lollipop color"].switch.value&&(g=h.categoryList.map(t=>h.controlData.lollipop["Lollipop color"][t].value),console.log(g),i.range(g)),h.colorScale=i;let s={},c=n.map(t=>(s[t.data.name]=t.x-o/2,{innerScaleKey:t.data.name,value:a.get(t.data.name)[e],colorScaleKey:a.get(t.data.name)[l]}));var g=d3.scaleLinear().domain([t,r].map(t=>t<0?0:t)).range([h.controlData.lollipop["Lollipop size"]["min-radius"].value,h.controlData.lollipop["Lollipop size"]["max-radius"].value]);c.barStyle=h.controlData.lollipop["Lollipop style"],c.textStyle=h.controlData.lollipop["Lollipop text"],c.lineStyle=h.controlData.lollipop["Line style"],h.controlData.lollipop["Lollipop size"].switch.value?(c.rScale=g,h.controlData.lollipop["Lollipop style"].r.isSvgAttr=!1):h.controlData.lollipop["Lollipop style"].r.isSvgAttr=!0,c.initType=null,c.innerScale=t=>s[t],c.innerScale.bandwidth=()=>o,c.colorScale=i,c.valueScale=d,this.barPlot.drawHorizontalLollipop(u,c)}})}drawLinks(){let t=this.layerPlaneData.layerStatistic["link between two nodes"]||[];this.figureData.leaves["Leaves Extension"].extension.value;let c={};this.root.leaves().forEach(t=>{c[t.data.name]={x:this.maxLength,y:t.x}});let h=d3.line().curve(d3.curveBundle).y(t=>t.y).x(t=>t.x);console.log(c),t.forEach((s,t)=>{if(s.isShowObj.isShow){let r=this.layerDataDict[s.layerDataFlieKey].dataSource;console.log("9jjj",r),console.log(this.root.leaves());let i=s.controlData.link["Link color"]["color-type"];var a,o=r.map(t=>{var a=s.controlData.link["Link style"]["link-type"],e=Math.abs(c[t.source].y-c[t.target].y)/2,l=s.controlData.link["Link style"]["offset-x"].value,r={x:c[t.source].x+l,y:c[t.source].y},o=(this.maxLength,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,{x:this.maxLength+e+l,y:(c[t.source].y+c[t.target].y)/2}),t=(this.maxLength,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,Math.sin(Math.PI/4),c[t.source].y,c[t.target].y,{x:c[t.target].x+l,y:c[t.target].y});if("pure"==i.optionList[i.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value)return"elliptical"==a.optionList[a.value]?h([r,o,t]):h([r,t]);let n="elliptical"==a.optionList[a.value]?splitPath(h,[r,o,t]):splitPath(h,[r,t]);return Array.from(n.split(8))});if(console.log("pathData",o),"pure"==i.optionList[i.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){let l=d3.scaleOrdinal().domain(s.categoryList);return s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value&&(a=s.categoryList.map(t=>s.controlData.link["Color categories"][t].value),console.log(a),l.range(a)),s.colorScale=l,void this.maingroup.append("g").selectAll("nodelink").data(o).join("path").attr("d",t=>t).attr("fill","none").attr("stroke",(t,a)=>{if(s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){var e=r.columns[s.layerDataColumnsIndex[2]];return l(r[a][e])}return s.controlData.link["Link color"].pure.value}).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}o=d3.transpose(o);d3.interpolateRgbBasis(["#ffffff","#ff6668"]);let e=d3.interpolateRgbBasis([s.controlData.link["Link color"].source.value,s.controlData.link["Link color"].target.value]);this.maingroup.append("g").selectAll("nodelink").data(o).join("path").attr("d",t=>t.join("")).attr("fill","none").attr("stroke",(t,a)=>e(d3.easeQuad(a/255))).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}})}drawHeatmap(){const g=this;let t=g.layerPlaneData.layerStatistic.heatmap||[];console.log("heatmap"),console.log(t);let m=this.innerHeight/this.root.leaves().length;t.forEach((s,t)=>{if(s.isShowObj.isShow){var c=this.layerDataDict[s.layerDataFlieKey].dataSource;let l=this.layerDataDict[s.layerDataFlieKey].dataIndex,r=c.columns;this.root.leaves().filter(t=>l.has(t.data.name));let a=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return s.layerDataColumnsIndex.forEach(t=>{a[r[t]]=l.get(e.data.name)[r[t]]}),a}return null});a.columns=s.layerDataColumnsIndex.map(t=>r[t]),console.log(a);var h=s.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(a.columns).range([0,h]),o=t.bandwidth(),e=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`),n=g.getMaxMinValue(a.filter(t=>null!=t),a.columns);var d=parseFloat(s.controlData.legend["ColorBar range"]["max-value"].value)||0;d>n[1]&&(n[1]=d);var u=parseFloat(s.controlData.legend["ColorBar range"]["min-value"].value)||0;u<n[0]&&(n[0]=u),s.mmv=n,s.customColorInterpolate=d3[s.colorInterpolate||"interpolateRdBu"],s.controlData.cell["Color bar"]["custom-color"].value&&(c=s.controlData.cell["Color bar"]["gradient-type"],h=s.controlData.cell["Color bar"].start.value,d=s.controlData.cell["Color bar"].middle.value,u=s.controlData.cell["Color bar"].end.value,"start-end"==c.optionList[c.value]?s.customColorInterpolate=d3.scaleLinear().domain([0,1]).range([h,u]):s.customColorInterpolate=d3.scaleLinear().domain([0,.5,1]).range([h,d,u]));let i=d3.scaleSequential(s.controlData.legend["ColorBar range"].reverse.value?[s.mmv[1],s.mmv[0]]:s.mmv,s.customColorInterpolate);if(s.controlData.legend["ColorBar range"]["median-value"].value){let e=Number(s.controlData.legend["ColorBar range"]["median-value"].value);i=t=>{let a=d3.scaleLinear().domain(s.controlData.legend["ColorBar range"].reverse.value?[n[1],e,n[0]]:[n[0],e,n[1]]).range([0,.5,1]);return s.customColorInterpolate(a(t))}}this.addAxis(s.controlData,e,t),e.selectAll(".row").data(a).join("g").attr("transform",(t,a)=>`translate(0,${a*m})`).filter(t=>null!=t).each(function(e,t){let l=d3.select(this);a.columns.forEach((a,t)=>{null!=e[a]&&(l.append("rect").attr("x",t*o).attr("width",o+.5).attr("height",.5+m).attr("fill",t=>s.controlData.cell["Cell style"].notFillZero.value&&0==t[a]?"none":i(t[a])).call(t=>{g.renderAttr(t,s.controlData.cell["Cell style"])}).attr("stroke-width",t=>s.controlData.cell["Cell style"].notFillZero.value&&0==t[a]?0:s.controlData.cell["Cell style"]["stroke-width"].value).append("title").text(t=>t[a]),s.controlData.cell["Cell text"].switch.value&&l.append("text").text(t=>s.controlData.cell["Cell style"].notFillZero.value&&0==t[a]?"":t[a]).attr("x",(t+.5)*o).attr("y",.5*m).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{g.renderAttr(t,s.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(i(t[a])).l?"#222":"#fff"}))})})}})}drawStackedBarPlot(){let t=this.layerPlaneData.layerStatistic["stacked bar plot"]||[];console.log(t);this.innerHeight,this.root.leaves().length;t.forEach((s,t)=>{if(s.isShowObj.isShow){var c=this.layerDataDict[s.layerDataFlieKey].dataSource;let r=this.layerDataDict[s.layerDataFlieKey].dataIndex,o=c.columns,t=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={x:l.x},e=0;s.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]||0}),e!=s.layerDataColumnsIndex.length&&t.push(a)}}),t.columns=s.layerDataColumnsIndex.map(t=>o[t]);let a=d3.stack().keys(t.columns).offset(d3.stackOffsetNone)(t);console.log(t),console.log(a);c=s.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleLinear().domain([0,d3.max(a,t=>d3.max(t,t=>t[1]))]).range([0,c]),l=d3.scaleOrdinal().domain(a.map(t=>t.key)).range(0==s.categoryColorList.length?["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"]:s.categoryColorList);s.isUseColorGradient&&l.range(d3.quantize(d3[s.colorInterpolate],l.domain().length)),s.controlData.bar["Custom color"].switch.value&&(c=a.map(t=>s.controlData.bar["Custom color"][t.key].value),l.range(c)),s.colorScale=l,console.log("9kk",s.categoryColorList);let n=this.innerHeight/this.root.leaves().length*(1-s.controlData.bar["Bar style"].padding.value),i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+Number(s.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(s.controlData,i,e),i.selectAll(".barG").data(a).join("g").attr("class",s.controlData.bar["Bar style"].id).attr("fill",t=>l(t.key)).call(t=>{this.renderAttr(t,s.controlData.bar["Bar style"]),t.append("title").text(t=>t.key),t.selectAll("rect").data(t=>t).join("rect").attr("y",t=>t.data.x-n/2).attr("width",t=>e(t[1])-e(t[0])).attr("height",n).attr("x",t=>e(t[0]))})}})}drawBoxPlot(){const h=this;let t=h.layerPlaneData.layerStatistic["base box plot"]||[];console.log(t),t.forEach((n,t)=>{if(n.isShowObj.isShow){var l=this.layerDataDict[n.layerDataFlieKey].dataSource;let r=this.layerDataDict[n.layerDataFlieKey].dataIndex,o=l.columns,i=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={leafName:l.data.name},e=0;n.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]}),e!=n.layerDataColumnsIndex.length&&i.push(a)}}),i.columns=n.layerDataColumnsIndex.map(t=>o[t]),console.log(i);var s=h.getMaxMinValue(i,i.columns),c=n.controlData.canvas["Canvas scale"].width.value,l=d3.scaleLinear().domain(s).range([0,c]),s=d3.scaleOrdinal().range([n.controlData.box["Box style"].fill.value]);let t=i.map(a=>{let e=i.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,n]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,min:t,q1:l,m:r,q3:o,max:n,sd:null,dataArr:e}}),a=this.innerHeight/this.root.leaves().length*(1-n.controlData.box["Box style"].padding.value),e={};this.root.leaves().forEach(t=>{e[t.data.name]=t.x-a/2});c=function(t){return e[t]};c.bandwidth=()=>a,t.innerxScale=c,t.xScale=l,t.colorScale=s,t.boxStyle=n.controlData.box["Box style"],t.pointStyle=n.controlData.point["Point style"],t.significanceStyle=n.controlData.significance,console.log("9kk",n.categoryColorList);s=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+Number(n.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(n.controlData,s,l),h.barPlot.drawHorizontalBox(s,t)}})}drawBoxPlotCategory(){const u=this;let t=u.layerPlaneData.layerStatistic["box plot with category"]||[];console.log(t),t.forEach((o,t)=>{if(o.isShowObj.isShow){var n=this.layerDataDict[o.layerDataFlieKey].dataSource;let i=this.layerDataDict[o.layerDataFlieKey].dataIndex,r=n.columns,s=n.columns[o.layerDataColumnsIndex[0]],c=[],t=o.layerDataColumnsIndex.slice(1);this.root.leaves().forEach(l=>{if(i.has(l.data.name)){let a={leafName:l.data.name},e=0;t.forEach(t=>{null==i.get(l.data.name)[r[t]]&&e++,a[r[t]]=i.get(l.data.name)[r[t]]}),e!=t.length&&c.push(a)}}),c.columns=t.map(t=>r[t]),console.log(c);var h=u.getMaxMinValue(c,c.columns),d=o.controlData.canvas["Canvas scale"].width.value,n=d3.scaleLinear().domain(h).range([0,d]),h=d3.scaleOrdinal().domain(o.categoryList).range(o.categoryColorList);o.colorScale=h;let a=c.map(a=>{let e=c.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,n]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,colorScaleKey:i.get(a.leafName)[s],min:t,q1:l,m:r,q3:o,max:n,sd:null,dataArr:e}}),e=this.innerHeight/this.root.leaves().length*(1-o.controlData.box["Box style"].padding.value),l={};this.root.leaves().forEach(t=>{l[t.data.name]=t.x-e/2});d=function(t){return l[t]};d.bandwidth=()=>e,a.innerxScale=d,a.xScale=n,a.colorScale=h,a.boxStyle=o.controlData.box["Box style"],a.pointStyle=o.controlData.point["Point style"],a.significanceStyle=o.controlData.significance,console.log("9kk",o.categoryColorList);h=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+Number(o.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(o.controlData,h,n),u.barPlot.drawHorizontalBox(h,a)}})}drawBinary2(){let t=this.layerPlaneData.layerStatistic["binary type 2"]||[];console.log("heatmap"),console.log(t);let s=this.innerHeight/this.root.leaves().length;t.forEach((n,t)=>{if(n.isShowObj.isShow){var i=this.layerDataDict[n.layerDataFlieKey].dataSource;let l=this.layerDataDict[n.layerDataFlieKey].dataIndex,r=i.columns,a=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return n.layerDataColumnsIndex.forEach(t=>{a[r[t]]=l.get(e.data.name)[r[t]]}),a}return null});a.columns=n.layerDataColumnsIndex.map(t=>r[t]),console.log(a);i=n.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(a.columns).range([0,i]),o=t.bandwidth(),e=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(n.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(n.controlData,e,t),e.selectAll(".row").data(a).join("g").attr("transform",(t,a)=>`translate(0,${a*s})`).filter(t=>null!=t).call((e,t)=>{a.columns.forEach((a,t)=>{e.filter(t=>null!=t[a]).append("rect").attr("x",t*o).attr("width",o).attr("height",s).attr("class",n.controlData.cell["Cell style"].id).attr("fill-opacity",t=>n.controlData.cell["Custom color"].switch.value?(n.controlData.cell["Cell style"].fill.isSvgAttr=!1,1):0==t[a]?.4:1).attr("fill",t=>(n.controlData.cell["Custom color"].switch.value?0==t[a]?n.controlData.cell["Custom color"].absent:n.controlData.cell["Custom color"].present:n.controlData.cell["Cell style"].fill).value).call(t=>{this.renderAttr(t,n.controlData.cell["Cell style"])}).append("title").text(t=>t[a]),n.controlData.cell["Cell text"].switch.value&&e.append("text").text(t=>t[a]).attr("x",(t+.5)*o).attr("y",.5*s).attr("dy","0.35em").attr("class",n.controlData.cell["Cell text"].id).attr("text-anchor","middle").call(t=>{this.renderAttr(t,n.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(n.controlData.cell["Cell style"].fill.value).l?"#222":"#fff"})})})}})}drawBinary(){let t=this.layerPlaneData.layerStatistic["binary type 1"]||[];console.log(t);let h=this.innerHeight/this.root.leaves().length;t.forEach((i,t)=>{if(i.isShowObj.isShow){let l=this.layerDataDict[i.layerDataFlieKey].dataIndex,e=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return i.categoryList.forEach(t=>{a[t]=l.get(e.data.name)[t]}),a}return null});e.columns=i.categoryList,console.log(e);var s=i.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(e.columns).range([0,s]),r=t.bandwidth(),a=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(i.controlData.canvas["Canvas scale"].x.value)},0)`),o=d3.scaleOrdinal().domain(e.columns).range(0==i.categoryColorList.length?["#cccccc"]:i.categoryColorList);i.controlData.cell["Custom color"].switch.value&&o.range(i.categoryList.map(t=>i.controlData.cell["Custom color"][t].value)),this.addAxis(i.controlData,a,t);var c=Math.min(r,h)/2*i.controlData.cell["Cell style"]["size-rate"].value,s=i.controlData.cell["Cell style"]["symbol-type"],s=s.optionList[s.value];let n=this.symbolGenerator.getPath(s,c);a.selectAll(".row").data(e).join("g").attr("transform",(t,a)=>`translate(0,${a*h})`).filter(t=>null!=t).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=t[a]).append("g").attr("transform",(t,a)=>`translate(${(e+.5)*r},${h/2})`).append("path").attr("d",n).attr("fill",t=>0==t[a]?"none":o(a)).attr("stroke",t=>o(a)).attr("class",i.controlData.cell["Cell style"].id).call(t=>{this.renderAttr(t,i.controlData.cell["Cell style"])}).append("title").text(t=>t[a])})})}})}drawBubblePlot(){const u=this;let t=u.layerPlaneData.layerStatistic["bubble plot"]||[];console.log(t);let g=this.innerHeight/this.root.leaves().length;t.forEach((s,t)=>{if(s.isShowObj.isShow){let l=this.layerDataDict[s.layerDataFlieKey].dataIndex,e=this.root.leaves().map(e=>{if(l.has(e.data.name)){let a={};return s.categoryList.forEach(t=>{a[t]=l.get(e.data.name)[t]}),a}return null});e.columns=s.categoryList,console.log(e);var c=u.getMaxMinValue(e.filter(t=>null!=t),e.columns);s.mmv=c;var h=s.controlData.canvas["Canvas scale"].width.value;let t=d3.scaleBand().domain(e.columns).range([0,h]),r=t.bandwidth(),a=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`),o=d3.scaleOrdinal().domain(e.columns).range(0==s.categoryColorList.length?["#cccccc"]:s.categoryColorList);console.log(s.controlData),s.controlData.bubble["Custom color"].switch.value&&o.range(s.categoryList.map(t=>s.controlData.bubble["Custom color"][t].value)),s.controlData.bubble["Pure color"].switch.value&&o.range([s.controlData.bubble["Pure color"].fill.value]),this.addAxis(s.controlData,a,t);var d=Math.min(r,g)/2,h=s.controlData.bubble["Bubble size"]["max-radius"].value;let n=d3.scaleLinear().domain([0,c[0],c[1]]).range([0,s.controlData.bubble["Bubble size"]["min-radius"].value,d<h?h:d]);s.rScale=n;d=s.controlData.bubble["Bubble style"]["symbol-type"];let i=d.optionList[d.value];s.symbolType=i,a.selectAll(".row").data(e).join("g").attr("transform",(t,a)=>`translate(0,${a*g})`).filter(t=>null!=t).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=t[a]).append("g").attr("transform",(t,a)=>`translate(${(e+.5)*r},${g/2})`).append("path").attr("d",t=>this.symbolGenerator.getPath(i,n(t[a]))).attr("fill",t=>o(a)).attr("class",s.controlData.bubble["Bubble style"].id).call(t=>{this.renderAttr(t,s.controlData.bubble["Bubble style"])}).append("title").text(t=>t[a])})})}})}drawTextLabel(){let t=this.layerPlaneData.layerStatistic["text map"]||[];console.log(t);let d=this.innerHeight/this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,a=this.layerDataDict[c.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=c.layerDataColumnsIndex.map(t=>a.columns[t]),o=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});o.columns=r,console.log(o);var h=c.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleBand().domain(o.columns).range([0,h]),n=e.bandwidth(),i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`),s=d3.scaleOrdinal().domain(o.columns).range(0==c.categoryColorList.length?["#cccccc"]:c.categoryColorList);c.controlData.text["Custom color"].switch.value&&s.range(c.categoryList.map(t=>c.controlData.text["Custom color"][t].value)),this.addAxis(c.controlData,i,e),i.selectAll(".row").data(o).join("g").attr("transform",(t,a)=>`translate(0,${a*d})`).call((e,t)=>{o.columns.forEach((a,t)=>{e.filter(t=>null!=t[a]).append("text").attr("x",(t+.5)*n).attr("y",d/2).attr("dy","0.35em").attr("fill",t=>s(a)).attr("class",c.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,c.controlData.text["Text style"])}).text(t=>t[a])})})}})}drawTextLabelCategory(){let t=this.layerPlaneData.layerStatistic["text map with category"]||[];console.log(t);let d=this.innerHeight/this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,a=this.layerDataDict[c.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=c.layerDataColumnsIndex.map(t=>a.columns[t]),o=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});o.columns=r.slice(1),console.log(o);var h=c.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleBand().domain(o.columns).range([0,h]),n=e.bandwidth(),i=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(c.controlData.canvas["Canvas scale"].x.value)},0)`),s=d3.scaleOrdinal().domain(c.categoryList).range(0==c.categoryColorList.length?["#cccccc"]:c.categoryColorList);c.controlData.text["Custom color"].switch.value&&s.range(c.categoryList.map(t=>c.controlData.text["Custom color"][t].value)),c.colorScale=s,this.addAxis(c.controlData,i,e),i.selectAll(".row").data(o).join("g").attr("transform",(t,a)=>`translate(0,${a*d})`).call((e,t)=>{o.columns.forEach((a,t)=>{e.filter(t=>null!=t[a]).append("text").attr("x",(t+.5)*n).attr("y",d/2).attr("dy","0.35em").attr("fill",t=>s(t[r[0]])).attr("class",c.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,c.controlData.text["Text style"])}).text(t=>t[a])})})}})}drawTextBlock(){let t=this.layerPlaneData.layerStatistic["color block of leaves name"];t&&t.forEach((d,u)=>{var g=this.layerDataDict[d.layerDataFlieKey].dataSource;let m=this.layerDataDict[d.layerDataFlieKey].dataIndex,p=g.columns[d.layerDataColumnsIndex[0]],y=d3.scaleOrdinal().domain(d.categoryList).range(d.categoryColorList);if(d.isUseColorGradient&&y.range(d3.quantize(d3[d.colorInterpolate],y.domain().length)),d.controlData.color["Custom color"].switch.value&&y.range(d.categoryList.map(t=>d.controlData.color["Custom color"][t].value)),d.colorScale=y,this.maingroup.append("defs").selectAll(".gradient").data(d.categoryList).join("linearGradient").each(function(t,a){let e=d3.select(this);e.attr("id",t=>`cboln-${t.replaceAll("'","-").replaceAll(" ","-").trim()}-${u}`).attr("x1","100%").attr("x2","0%").attr("y1","50%").attr("y2","50%"),e.append("stop").attr("offset","0%").attr("stop-color",t=>y(t)).attr("stop-opacity",d.controlData.color["Color gradient"].reverse.value?1:0),e.append("stop").attr("offset","50%").attr("stop-color",t=>y(t)).attr("stop-opacity",.3),e.append("stop").attr("offset","100%").attr("stop-color",t=>y(t)).attr("stop-opacity",d.controlData.color["Color gradient"].reverse.value?0:1)}),console.log(d.categoryColorList),d.isShowObj.isShow){let l=[],r=void 0,o=1/0,n=null,i=this.root.leaves();function v(a,t){return t.every(t=>a.leaves().includes(t))?a:v(a.parent,t)}i.forEach((t,a)=>{let e=m.has(t.data.name)&&m.get(t.data.name)[p]||"";e!=r&&(l.push({name:e.toString(),start:a,end:0,node_arr:[]}),0<=l.length-2&&(l[l.length-2].end=a-1,l[l.length-2].LCA=v(n,l[l.length-2].node_arr),l[l.length-2].maxChidrenLength=d3.max(l[l.length-2].node_arr,t=>t.branchLength),o=t.depth,n=t)),l[l.length-1].node_arr.push(t),t.depth<o&&(o=t.depth,n=t),r=e,a==i.length-1&&(l[l.length-1].end=a,l[l.length-1].LCA=v(n,l[l.length-1].node_arr),l[l.length-1].maxChidrenLength=d3.max(l[l.length-1].node_arr,t=>t.branchLength))}),console.log("block_data",l),l=l.filter(t=>""!=t.name);let t=this.maingroup.append("g").lower(),e=this.innerHeight/i.length,s=d.controlData.block.block.width.value,a=d.controlData.block.block.padding.value;g=d.controlData.block.block["width-type"];let c=g.optionList[g.value],h=[];"from branch tip to uniform end"==c&&(i.forEach((t,a)=>{m.has(t.data.name)&&m.get(t.data.name)[p]&&h.push({name:m.get(t.data.name)[p].toString(),start:a,end:a,branchLength:t.branchLength})}),console.log("from branch tip to uniform end",l)),t.selectAll("taxblock_t").data("from branch tip to uniform end"==c?h:l).join("g").attr("transform",t=>"uniform start and end"==c?`translate(${this.maxLength+d.controlData.block.block.x.value},0)`:"from branch tip to uniform end"==c?`translate(${t.branchLength},0)`:`translate(${t.LCA.branchLength-t.LCA.data.length*this.treeScale/2},0)`).append("rect").attr("class",`color-block-${u}`).attr("y",t=>t.start*e+a/2).attr("rx",d.controlData.block.block.rx.value).attr("ry",d.controlData.block.block.ry.value).attr("fill-opacity",d.controlData.block.block["fill-opacity"].value).attr("width",t=>"uniform start and end"==c?s:"from LCA to uniform end"==c?this.maxLength-(t.LCA.branchLength-t.LCA.data.length*this.treeScale/2)+d.controlData.block.block["width-offset"].value:"from branch tip to uniform end"==c?this.maxLength-t.branchLength+d.controlData.block.block["width-offset"].value:"from LCA to max length of children"==c?t.maxChidrenLength-(t.LCA.branchLength-t.LCA.data.length*this.treeScale/2)+d.controlData.block.block["width-offset"].value:void 0).attr("height",t=>(t.end-t.start+1)*e-a).call(t=>{if(d.controlData.color["Color gradient"].switch.value?t.attr("fill",t=>`url('#cboln-${t.name.replaceAll("'","-").replaceAll(" ","-").trim()}-${u}')`):(t.attr("fill",t=>y(t.name)),"from branch tip to uniform end"==c&&t.clone().attr("fill","none").attr("stroke",t=>y(t.name))),"from branch tip to uniform end"!=c){let a=d.controlData.block.block["stroke-as-fill"].value;t.attr("stroke",t=>a?y(t.name):d.controlData.block.block.stroke.value).attr("stroke-width",d.controlData.block.block["stroke-width"].value)}}),d.controlData.block.text.switch.value&&t.selectAll("taxblock_T").data(l).join("g").attr("transform",t=>{let a=this.maxLength+d.controlData.block.block.x.value+s;return"from LCA to uniform end"==c&&(a=this.maxLength+d.controlData.block.block["width-offset"].value),"from LCA to max length of children"==c&&(a=t.maxChidrenLength+d.controlData.block.block["width-offset"].value),`translate(${d.controlData.block.text.x.value+a},${(t.start+t.end+1)/2*e})`}).append("text").attr("transform",t=>`rotate(${d.controlData.block.text.rotate.value})`).attr("class",d.controlData.block.text.id).attr("fill",t=>d.controlData.block.text["fill-as-block"].value?y(t.name):d.controlData.block.text.fill.value).attr("dy",".3em").attr("text-anchor",t=>90==d.controlData.block.text.rotate.value?"middle":"start").text(t=>t.name).call(t=>{this.renderAttr(t,d.controlData.block.text)})}})}drawLengthAxis(){if(this.figureData["length axis"].Axis.switch.value){let t=this.maxLength/this.treeScale;var a=this.figureData["length axis"].Axis["position-type"],e=a.optionList[a.value],l=this.figureData["length axis"].Tick["scale-by-factor"].value,r=this.figureData["length axis"].Tick.reverseValues.value;0!=l&&(t*=l);var o=d3.scaleLinear().domain(r?[t,0]:[0,t]).range([0,this.innerwidth]),a=this.figureData["length axis"].Axis.offset.value,l=this.maingroup.append("g"),r={canvas:{"Canvas scale":{width:{value:this.innerwidth}}},xAxis:this.figureData["length axis"]};this.addAxis(r,l,o,"bottom"==e?"axisBottom":"axisTop",{vOffset:a})}}geologicTimeScale(){let t=this.layerPlaneData.layerStatistic["geologic time scale"]||[];t.forEach((s,t)=>{if(s.isShowObj.isShow){let t=this.layerDataDict[s.layerDataFlieKey].dataSource,[a,e,l]=t.columns.slice(1);var c=s.controlData.period.Position.offset.value;let r=this.maxLength/this.treeScale;var h=this.figureData["length axis"].Tick["scale-by-factor"].value;0!=h&&(r*=h);let o=d3.scaleLinear().domain([r,0]).range([0,this.innerwidth]),n=d3.scaleOrdinal().domain(s.categoryList).range(s.categoryColorList);s.controlData.period["Custom color"].switch.value&&n.range(s.categoryList.map(t=>s.controlData.period["Custom color"][t].value));let i=this.maingroup.append("g").attr("transform",`translate(0,${this.innerHeight+c})`).append("g").data([s.otherData.dragData]).attr("transform",t=>`translate(${t.x},${t.y})`).call(this.drag({enableX:!1})).selectAll("periodRect").data(t).join("g").attr("transform",t=>`translate(${o(t[e])},0)`);i.append("rect").attr("class",s.controlData.period["Period style"].id).attr("width",t=>o(t[l])-o(t[e])).attr("height",s.controlData.period["Period style"].height.value).attr("fill",t=>n(t[a])).call(t=>{this.renderAttr(t,s.controlData.period["Period style"])}),i.append("text").attr("class",s.controlData.period["Text style"].id).text(t=>t[a]).attr("x",t=>(o(t[l])-o(t[e]))/2).attr("y",s.controlData.period["Period style"].height.value/2).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{this.renderAttr(t,s.controlData.period["Text style"])})}})}drawRecombinationFragmentMap(){let t=this.layerPlaneData.layerStatistic["recombination fragment map"]||[];t.forEach((s,t)=>{if(s.isShowObj.isShow){let t=this.layerDataDict[s.layerDataFlieKey].dataSource,[a,e,l]=t.columns.slice(1),r=d3.group(t,t=>t[a]);var c=d3.max(t,t=>t[l]),h=s.controlData.canvas["Canvas scale"].width.value;let o=d3.scaleLinear().domain([0,c]).range([0,h]),n=this.maingroup.append("g").attr("transform",t=>`translate(${this.maxLength+parseInt(s.controlData.canvas["Canvas scale"].x.value)},0)`);this.addAxis(s.controlData,n,o);let i={};this.root.descendants().forEach(t=>{var a;r.has(t.data.uniformNodeId)&&(a=d3.extent(t.leaves(),t=>t.x),i[t.data.uniformNodeId]={start:a[0],height:a[1]-a[0]})}),n.append("g").selectAll("NodeG").data(Object.keys(i)).join("g").attr("transform",t=>`translate(0,${i[t].start})`).selectAll("fragmentRect").data(t=>r.get(t)).join("rect").attr("height",t=>i[t[a]].height).attr("width",t=>o(t[l])-o(t[e])).attr("x",t=>o(t[e])).attr("fill","red"),console.log("drawRecombinationFragmentMap",i)}})}addAxis(a,t,e,l="axisTop",{vOffset:r}={}){if(a.xAxis.Axis){if(!a.xAxis.Axis.switch.value)return;var o;"position-type"in a.xAxis.Axis&&(o=a.xAxis.Axis["position-type"],l="bottom"==o.optionList[o.value]?"axisBottom":"axisTop",r=a.xAxis.Axis.offset.value)}a.background&&a.background.Background.switch.value&&t.insert("rect","#maingroup g:nth-child(1)").attr("class",a.background.Background.id).attr("width",a.canvas["Canvas scale"].width.value).attr("height",this.innerHeight).call(t=>{this.renderAttr(t,a.background.Background)});const n=a.xAxis.Tick,i=d3[l](e);n.hasOwnProperty("tickValues")&&n.tickValues.value&&i.tickValues(n.tickValues.value.split(",")),n.hasOwnProperty("tickFormat")&&n.tickFormat.value&&i.tickFormat(d3.format(`${n.tickFormat.value}`));const s=t.append("g").call(i).attr("id","xAxis").attr("font-family",null);r*="axisBottom"==l?-1:1,"axisBottom"==l?s.attr("transform",`translate(0,${this.innerHeight+r})`):s.attr("transform",`translate(0,${r})`);e=a.xAxis["Text style"];s.selectAll(".tick text").remove(),e.switch.value&&(t=s.selectAll(".tick").append("g").attr("transform",t=>`translate(0,${("axisBottom"==l?-1:1)*a.xAxis["Text style"].offset.value})`).append("text").text(t=>n.hasOwnProperty("tickFormat")&&n.tickFormat.value?d3.format(`${n.tickFormat.value}`)(t):t).attr("class",e.id).attr("dy","0.35em"),n.hasOwnProperty("tickFormat")&&n.tickFormat.value.endsWith("E")&&s.selectAll(".tick text").call(t=>{this.valueFormat(t,n.tickFormat.value)}),this.renderAttr(t,e));e=s.append("g").attr("transform",`translate(${a.canvas["Canvas scale"].width.value/2},0)`).append("text").attr("class",a.xAxis.Label.id).attr("text-anchor","middle");this.renderAttr(e,a.xAxis.Label),this.renderText(e,a.xAxis.Label.text.value),s.selectAll(".tick line").attr("class","tick-line").call(t=>{this.renderAttr(t,n)}),n.hasOwnProperty("tickFormat")&&n.tickFormat.value.endsWith("E")&&s.selectAll(".tick text").call(t=>{this.valueFormat(t,n.tickFormat.value)}),a.xAxis.Grid&&a.xAxis.Grid.switch.value&&(r=s.selectAll(".tick line").clone().attr("class",a.xAxis.Grid.id).attr("y2",("axisBottom"==l?-this.innerHeight:this.innerHeight)-(r||0)),this.renderAttr(r,a.xAxis.Grid)),s.selectAll(".domain").call(t=>{this.renderAttr(t,n)}).raise(),a.xAxis.Tick.removePath.value&&s.selectAll(".domain").remove(),a.xAxis.Tick.removeTick.value&&s.selectAll(".tick .tick-line").remove()}}window.normalTree=new NormalTree,normalTree.setExampleData(["/static/Ali/data/NJ_tree.treefile"]);let queryParams=new URLSearchParams(window.location.search);if(queryParams.has("originalJsonDataUri")){let t=queryParams.get("originalJsonDataUri");d3.json(t).then(t=>{normalTree.importOriginalJsonData(t),d3.select("#page-loading-box").remove()})}else d3.text("/static/Ali/data/NJ_tree.treefile").then(function(t){normalTree.onLoadNewFile(t),d3.select("#page-loading-box").remove()});