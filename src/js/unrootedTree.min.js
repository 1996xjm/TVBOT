import{MainTree,maxLength,getNodeHeight}from"/static/xiaochiPlot/minJS/mainTree.min.js";import{BarPlot}from"/static/xiaochiPlot/js/barPlot.js";import{hull}from"/static/xiaochiPlot/js/hull/hull.js";import{splitPath}from"/static/xiaochiPlot/js/splitPath.js";class NormalTree extends MainTree{constructor(){super("treefile"),this.barPlot=new BarPlot(this),this.plotType="unrootedTree",this.creatVueApp()}init(t,a,e){"attrChanged"==t&&"Branches sorting"==e||"originalJsonData"==t?this.reRootTree(this.styleData.rootNodeIndex,this.styleData.rootOffsetRate):("attrChanged"==t&&"data-source"==a&&"Bootstraps"==e&&(e=(e=this.figureData.branches.Bootstraps["data-source"]).optionList[e.value],console.log(99999,e),e in this.btRangeDict?(console.log(this.btRangeDict[e]),this.figureData.branches.Bootstraps.from.value=this.btRangeDict[e][0],this.figureData.branches.Bootstraps.to.value=this.btRangeDict[e][1]):(this.figureData.branches.Bootstraps.from.value=0,this.figureData.branches.Bootstraps.to.value=0),this.Vue.$refs.controlPlane.$forceUpdate()),this.zoomG.text(""),super.init(t),this.outerRadius=this.innerwidth,console.log(this.treeHierarchy),this.polarGroup=this.maingroup.append("g").attr("transform",`translate(${this.innerwidth/2},${this.innerHeight/2})`).attr("id","polarGroup"),this.treeEndAngle=this.figureData.leaves["Circle size"].endAngle.value,this.root=d3.cluster().size([this.treeEndAngle,this.outerRadius]).separation((t,a)=>1)(this.treeHierarchy),null==this.rootLength?this.root.data.length=0:this.root.data.length=this.rootLength,this.treeStartAngle=-90,this.treeScale=parseFloat(this.outerRadius)/parseFloat(maxLength(this.root.data,this.figureData.branches.Branches["ignore-length"].value)),this.setRadius(this.root,0,this.treeScale,getNodeHeight(this.root),getNodeHeight(this.root)+1),this.maxLength=this.outerRadius,console.log(this.root),this.drawTree(),this.drawCollapseClade(),this.drawTextBlock(),this.drawSymbol(),this.drawPieChart("circle"),this.drawBarPlot(),this.drawBaseBarPlot(),this.drawLinks(),this.drawHeatmap(),this.drawStackedBarPlot(),this.drawBoxPlot(),this.drawBinary(),this.drawBinary2(),this.drawTextLabel(),this.drawTextLabelCategory(),this.drawBranchTextLabel("unrooted"),this.colorBranch(),this.drawLegend(),this.setGlobalFontStyle())}getAbsolutePosition(t,a,e){if(null==t.parent)return{x:a,y:e};var l=Math.sqrt(Math.pow(a,2)+Math.pow(e,2));let r=0==a?0:Math.atan(e/a);a<0&&0<e&&(r+=Math.PI),a<0&&e<0&&(r-=Math.PI);var o=l*Math.cos((t.absoluteAngle-90)*Math.PI/180+r)+t.absolutePosition.x;return isNaN(o)&&(console.log(a,e),console.log(l*Math.cos((t.absoluteAngle-90)*Math.PI/180+r),t.absolutePosition.x)),{x:o,y:l*Math.sin((t.absoluteAngle-90)*Math.PI/180+r)+t.absolutePosition.y}}drawTree(){const r=this;let a=this.figureData.branches.Branches,o=this.figureData.branches.Bootstraps;var l=o.type;let t=l.optionList[l.value];o.switch.value||(t="None");let u=(o,s,t)=>{let n=0;o.children.forEach(t=>{n+=t.leaves().length});let i=t-s;t=this.figureData.branches.Branches["link-type"];let c=t.optionList[t.value],d=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle);"bezierX"==c?d.curve(d3.curveBumpX):"bezierY"==c&&d.curve(d3.curveBumpY);let h=0;o.children.forEach(t=>{t.startAngle=s,t.endAngle=s+i*t.leaves().length/n,t.middleAngle=(t.startAngle+t.endAngle)/2;var a=90-i/2+i*t.leaves().length/n/2+h;h+=i*t.leaves().length/n,o.parent?(t.middleAngle=a,t.absoluteAngle=t.middleAngle+o.absoluteAngle-90):(o.absolutePosition={x:0,y:0},o.absoluteAngle=0,t.absoluteAngle=t.middleAngle+o.absoluteAngle);var e=this.figureData.branches.Branches["ignore-length"].value?this.outerRadius/getNodeHeight(this.root):t.data.length*this.treeScale,a=[{angle:0,radius:0},{angle:t.middleAngle*Math.PI/180,radius:e}];t.unrootedRadius=e;let l=d(a),r=[];r="linear"==c?l.split("L")[1].split(","):l.split("C")[1].split(",").slice(-2);e=Number(r[0]),a=Number(r[1]);o.parent?t.absolutePosition=this.getAbsolutePosition(o,e,a):t.absolutePosition={x:o.absolutePosition.x+e,y:o.absolutePosition.y+a},s=t.endAngle,t.children&&u(t,t.startAngle,t.endAngle)})};u(this.root,0,this.figureData.leaves["Circle size"].endAngle.value),console.log(this.root.links());var s=this.figureData.branches.Branches["link-type"],l=s.optionList[s.value];let e=d3.line().x(t=>t.absolutePosition.x).y(t=>t.absolutePosition.y);"bezierX"==l?e.curve(d3.curveBumpX):"bezierY"==l&&e.curve(d3.curveBumpY),this.polarGroup.append("g").attr("fill","none").selectAll("branchpath").data(this.root.links()).join("path").attr("d",t=>e([t.source,t.target])).attr("class",a.id).attr("fill","none").attr("stroke",a.stroke.value).call(t=>{this.renderAttr(t,a)}).on("click",this.treeBranchClickFunction()).on("mouseenter",this.treeBranchEnterFunction()).on("mouseleave",this.treeBranchleaveFunction());let n=this.figureData.leaves["Text style"].x.value,i=this.figureData.leaves["Leaves Extension"].extension.value,c=this.outerRadius/2+this.figureData.leaves["Leaves Extension"].offset.value,d=this.polarGroup.append("g").selectAll("leaftext").data(this.root.leaves()).join("g").attr("transform",t=>`translate(${t.absolutePosition.x},${t.absolutePosition.y})rotate(${t.absoluteAngle-90})`);this.leafNodeG=d,d.append("text").attr("dy",".31em").attr("text-anchor",t=>t.absoluteAngle<180?"start":"end").attr("transform",t=>`translate(${n+(i?c:0)},0)${t.absoluteAngle<180?"":" rotate(180)"}`).attr("class",this.figureData.leaves["Text style"].id).call(t=>{this.drawLeafText(t,"circle")}),i&&d.append("line").attr("x2",c).attr("class",this.figureData.leaves["Leaves Extension"].id).call(t=>{this.renderAttr(t,this.figureData.leaves["Leaves Extension"])});s=this.figureData.branches.Bootstraps["data-source"];let h=s.optionList[s.value],g=this.Vue.$refs.controlPlane.$data.controlList[0];l=g.findIndex(t=>"BT legend"==t.tabName),s=g.findIndex(t=>"BT color bar legend"==t.tabName);let p;if(this.figureData.branches.Bootstraps.switch.value&&"None"!=h?p=this.polarGroup.append("g").selectAll("bt").data(this.root.descendants().filter(t=>t.children)).join("g").attr("transform",t=>`translate(${t.absolutePosition.x},${t.absolutePosition.y})rotate(${t.absoluteAngle-90})`):(t="None",g[l].isDisplay=!1,g[s].isDisplay=!1),"text"==t&&(g[l].isDisplay=!1,g[s].isDisplay=!1,p.each(function(t){let a=d3.select(this),e=0;var l;"bootstrap"==h&&"btArr"in t.data?e=t.data.btArr[0]:h in r.btRangeDict&&"otherProperty_L"in t.data&&(e=t.data.otherProperty_L[h]),e>=o.from.value&&e<=o.to.value&&(e*=o["scale-by-factor"].value,e=Number(e.toFixed(10)),l=0==o["round-decimals"].value&&e<1?e:d3.format(`.${o["round-decimals"].value}f`)(e),a.append("g").attr("transform",t=>t.absoluteAngle<180?null:"rotate(180)").append("g").datum(r.btDragData2[t.data.nodeIndex]).attr("transform",t=>`translate(${t.x},${t.y})`).call(r.drag()).append("text").attr("class",o.id).text(0!=l?l:"").call(t=>{r.renderAttr(t,o)}))})),"circle"==t&&(g[l].isDisplay=!0,g[s].isDisplay=!1,p.filter(t=>70<=t.data.name).append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(r.figureData.branches.Bootstraps["circle-size"].value)()).attr("fill",t=>90<t.data.name?"black":70<=t.data.name&&t.data.name<=90?"#aaaaaa":void 0)),"gradient color circle"==t){g[l].isDisplay=!1,g[s].isDisplay=!0;l=this.figureData["BT color bar legend"]["ColorBar range"];let t=[...this.btRangeDict[h]];s=l["max-value"].value;""!=s&&(t[1]=Number(s));s=l["min-value"].value;""!=s&&(t[0]=Number(s)),this.mmvBTvalue=t;let e=d3.scaleSequential(l.reverse.value?[t[1],t[0]]:t,d3[this.styleData.currentColorInterpolate]);l["median-value"].value&&(s=Number(l["median-value"].value),e=d3.scaleSequential(l.reverse.value?[t[1],s,t[0]]:[t[0],s,t[1]],d3[this.styleData.currentColorInterpolate])),p.filter(t=>{let a=0;return"bootstrap"==h&&"btArr"in t.data&&0<t.data.btArr.length?a=t.data.btArr[0]:h in r.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[h]),0!=a}).append("g").append("path").attr("d",t=>d3.symbol().type(d3.symbolCircle).size(this.figureData.branches.Bootstraps["circle-size"].value)()).attr("stroke-width",1).attr("stroke","#000000").attr("fill",t=>{let a=0;return"bootstrap"==h&&"btArr"in t.data?a=t.data.btArr[0]:h in r.btRangeDict&&"otherProperty_L"in t.data&&(a=t.data.otherProperty_L[h]),e(a)})}}drawSymbol(){let t=this.layerPlaneData.layerStatistic["add symbol"];t&&t.forEach((n,t)=>{if(n.isShowObj.isShow){let a=this.layerDataDict[n.layerDataFlieKey].dataSource,s=this.layerDataDict[n.layerDataFlieKey].dataIndex;a.columns[n.layerDataColumnsIndex[0]];var i=n.controlData.symbol["Symbol position"]["canvas-width"].value;let t=n.layerDataColumnsIndex.map(t=>a.columns[t]),e=d3.scaleBand().domain(t).range([0,i]).padding(n.controlData.symbol["Symbol position"].padding.value),l=d3.scaleOrdinal().domain(n.categoryList).range(n.categoryColorList);n.controlData.symbol["Symbol color"].switch.value&&l.range(n.categoryList.map(t=>n.controlData.symbol["Symbol color"][t].value)),n.colorScale=l;let r=parseFloat(n.controlData.symbol["Symbol position"].offset.value),o=parseFloat(n.controlData.symbol["Symbol style"].size.value);this.leafNodeG.filter(t=>s.has(t.data.name)).append("g").attr("transform",t=>`translate(${r},0)`).selectAll("symbolPath").data(r=>{console.log("kjhk",r);let o=[];return t.forEach(t=>{var a,e,l=s.get(r.data.name)[t];null!=l&&(a=n.controlData.symbol["Symbol type"][l].value,a=(e=n.controlData.symbol["Symbol type"][l].optionList[a].split("-"))[0],e=e[1],o.push({category:l,symbol_type:a,isFill:e,columnsName:t}))}),o}).join("g").attr("transform",t=>`translate(${e(t.columnsName)+e.bandwidth()/2},0)`).append("path").attr("d",t=>d3.symbol().type(d3[t.symbol_type]).size(o)()).attr("fill",t=>{var a=l(t.category);return"fill"==t.isFill?a:"none"}).attr("stroke",t=>{var a=l(t.category);return"fill"==t.isFill?n.controlData.symbol["Symbol style"].stroke.value:a}).attr("stroke-width",t=>{var a=n.controlData.symbol["Symbol style"]["stroke-width"].value;return"fill"==t.isFill||1<a?a:1})}})}drawCollapseClade(){const l=this;let t=this.root.leaves();var a=t.filter(t=>t.data.isCollapse);let r=this.treeEndAngle/t.length/2,e=this.figureData.branches.Branches,o=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle);this.polarGroup.append("g").selectAll("cladePath").data(a).join("path").attr("class",e.id).attr("d",t=>{var a=t.data.lengthMMV,e=this.outerRadius/getNodeHeight(this.root);return this.figureData.branches.Branches["ignore-length"].value?o([{radius:t.radius-e,angle:t.x*Math.PI/180},{radius:t.radius,angle:(t.x-r)*Math.PI/180},{radius:t.radius,angle:(t.x+r)*Math.PI/180}])+"Z":o([{radius:t.radius,angle:t.x*Math.PI/180},{radius:t.radius+a[0]*this.treeScale,angle:(t.x-r)*Math.PI/180},{radius:t.radius+a[1]*this.treeScale,angle:(t.x+r)*Math.PI/180}])+"Z"}).attr("fill-opacity",t=>this.figureData["folded clade"]["Clade style"]["fill-opacity"].value).attr("fill",t=>(this.figureData["folded clade"]["Custom color"].switch.value?this.figureData["folded clade"]["Custom color"][t.data.name]:this.figureData["folded clade"]["Clade style"].fill).value).attr("stroke",e.stroke.value).call(t=>{this.renderAttr(t,e)}).on("mouseenter",function(){let t=d3.select(this);t.attr("old-stroke",t.attr("stroke")),t.attr("stroke","#fc8d62")}).on("mouseleave",function(){console.log("leave");let t=d3.select(this);t.attr("stroke",t.attr("old-stroke"))}).on("click",function(t){console.log(t),t.stopPropagation();let[a]=d3.select(this).data();console.log("branchData",a),l.styleData.currentNodeIndex=a.data.nodeIndex;var e=t.clientX+10,t=t.clientY+10;l.layout_phylotree_context_menu_app.$data.clientX=e,l.layout_phylotree_context_menu_app.$data.clientY=t;t=l.styleData.collapseCladeList.findIndex(t=>t.nodeIndex==a.data.nodeIndex);l.layout_phylotree_context_menu_app.$data.btnItemArr[0].name=-1!=t?"Unfold this clade":"Fold this clade",a.children||-1!=t?l.layout_phylotree_context_menu_app.$data.btnItemArr[0].show=!0:l.layout_phylotree_context_menu_app.$data.btnItemArr[0].show=!1,l.layout_phylotree_context_menu_app.$data.isShowMenu=!0})}drawBarPlot(){let t=this.layerPlaneData.layerStatistic["bar plot with category"]||[];console.log("bar"),console.log(t),t.forEach((h,t)=>{if(h.isShowObj.isShow){var u=this.layerDataDict[h.layerDataFlieKey].dataSource;let e=this.layerDataDict[h.layerDataFlieKey].dataIndex,l=u.columns[h.layerDataColumnsIndex[1]],a=u.columns[h.layerDataColumnsIndex[0]];var g=d3.max(u,t=>t[l]),u=h.controlData.canvas["Canvas scale"].width.value;let r=h.controlData.canvas["Canvas scale"].x.value,o=2*(this.outerRadius+r)*Math.PI/this.root.leaves().length*(1-h.controlData.bar["Bar style"].padding.value)*this.treeEndAngle/360,s=d3.scaleLinear().domain([0,g]).range([0,u]),t=this.root.leaves().filter(t=>e.has(t.data.name)&&e.get(t.data.name)[l]),n=this.polarGroup.append("g"),i=d3.scaleOrdinal().domain(h.categoryList).range(h.categoryColorList);h.controlData.bar["Bar color"].switch.value&&(u=h.categoryList.map(t=>h.controlData.bar["Bar color"][t].value),console.log(u),i.range(u)),h.colorScale=i;let c=t.map(t=>{return{barStart:t.x-o/2,barWidth:o,barHeight:s(e.get(t.data.name)[l]),fill:i(e.get(t.data.name)[a]),text:e.get(t.data.name)[l],textY:s(e.get(t.data.name)[l])+10,textX:o/2}});c.barStyle=h.controlData.bar["Bar style"],c.textStyle=h.controlData.bar["Bar text"],c.initType=null,this.addAxis(h.controlData,n,s);let d=n.selectAll("newBar").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+r},0)`);if(d.append("rect").attr("width",t=>s(e.get(t.data.name)[l])).attr("height",o).attr("y",-o/2).attr("fill",t=>i(e.get(t.data.name)[a])).attr("class",h.controlData.bar["Bar style"].id).call(t=>{this.renderAttr(t,h.controlData.bar["Bar style"])}),h.controlData.bar["Bar text"].switch.value){let a=h.controlData.bar["Bar text"];d.append("g").attr("transform",t=>a.align&&a.align.value?`${t.x<180?"rotate(0)":"rotate(180)"}`:t.x<180?`translate(${s(e.get(t.data.name)[l])},0)`:`translate(${s(e.get(t.data.name)[l])},0) rotate(180)`).append("text").text(t=>e.get(t.data.name)[l]).attr("text-anchor",t=>90==a.rotate.value?"middle":t.x<180?"start":"end").attr("x",t=>t.x<180?a.x.value:-a.x.value).attr("class",a.id).call(t=>{this.renderAttr(t,a)})}}})}drawBaseBarPlot(){let t=this.layerPlaneData.layerStatistic["base bar plot"]||[];console.log("bar"),console.log(t),t.forEach((c,t)=>{if(c.isShowObj.isShow){var d=this.layerDataDict[c.layerDataFlieKey].dataSource;let e=this.layerDataDict[c.layerDataFlieKey].dataIndex,l=d.columns[c.layerDataColumnsIndex[0]];var h=d3.max(d,t=>t[l]),d=c.controlData.canvas["Canvas scale"].width.value;let a=c.controlData.canvas["Canvas scale"].x.value,r=2*(this.outerRadius+a)*Math.PI/this.root.leaves().length*(1-c.controlData.bar["Bar style"].padding.value)*this.treeEndAngle/360,o=d3.scaleLinear().domain([0,h]).range([0,d]),t=this.root.leaves().filter(t=>e.has(t.data.name)&&e.get(t.data.name)[l]),s=this.polarGroup.append("g"),n=t.map(t=>{return{barStart:t.x-r/2,barWidth:r,barHeight:o(e.get(t.data.name)[l]),fill:c.controlData.bar["Bar style"].fill.value,text:e.get(t.data.name)[l],textY:o(e.get(t.data.name)[l])+10,textX:r/2}});n.barStyle=c.controlData.bar["Bar style"],n.textStyle=c.controlData.bar["Bar text"],n.initType=null,this.addAxis(c.controlData,s,o);let i=s.selectAll("newBar").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+a},0)`);if(i.append("rect").attr("width",t=>o(e.get(t.data.name)[l])).attr("height",r).attr("y",-r/2).attr("class",c.controlData.bar["Bar style"].id).call(t=>{this.renderAttr(t,c.controlData.bar["Bar style"])}),c.controlData.bar["Bar text"].switch.value){let a=c.controlData.bar["Bar text"];i.append("g").attr("transform",t=>a.align&&a.align.value?`${t.x<180?"rotate(0)":"rotate(180)"}`:t.x<180?`translate(${o(e.get(t.data.name)[l])},0)`:`translate(${o(e.get(t.data.name)[l])},0) rotate(180)`).append("text").text(t=>e.get(t.data.name)[l]).attr("text-anchor",t=>90==a.rotate.value?"middle":t.x<180?"start":"end").attr("x",t=>t.x<180?a.x.value:-a.x.value).attr("class",a.id).call(t=>{this.renderAttr(t,a)})}}})}drawStackedBarPlot(){let t=this.layerPlaneData.layerStatistic["stacked bar plot"]||[];console.log(t);this.innerHeight,this.root.leaves().length;t.forEach((c,t)=>{if(c.isShowObj.isShow){var d=this.layerDataDict[c.layerDataFlieKey].dataSource;let r=this.layerDataDict[c.layerDataFlieKey].dataIndex,o=d.columns,t=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={x:l.x},e=0;c.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]||0}),e!=c.layerDataColumnsIndex.length&&t.push(a)}}),t.columns=c.layerDataColumnsIndex.map(t=>o[t]);let a=d3.stack().keys(t.columns).offset(d3.stackOffsetNone)(t);console.log(t),console.log(a);d=c.controlData.canvas["Canvas scale"].width.value;let e=c.controlData.canvas["Canvas scale"].x.value,l=d3.scaleLinear().domain([0,d3.max(a,t=>d3.max(t,t=>t[1]))]).range([0,d]),s=d3.scaleOrdinal().domain(a.map(t=>t.key)).range(0==c.categoryColorList.length?["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5","#ffed6f"]:c.categoryColorList);c.isUseColorGradient&&s.range(d3.quantize(d3[c.colorInterpolate],s.domain().length)),c.controlData.bar["Color row"].switch.value&&(d=a.map(t=>c.controlData.bar["Color row"][t.key].value),s.range(d)),c.colorScale=s,console.log("9kk",c.categoryColorList);let n=2*(this.outerRadius+e)*Math.PI/this.root.leaves().length*(1-c.controlData.bar["Bar style"].padding.value)*this.treeEndAngle/360,i=this.polarGroup.append("g");this.addAxis(c.controlData,i,l),i.selectAll(".barG").data(a).join("g").attr("class",c.controlData.bar["Bar style"].id).attr("fill",t=>s(t.key)).call(t=>{this.renderAttr(t,c.controlData.bar["Bar style"]),t.append("title").text(t=>t.key),t.selectAll("rect").data(t=>t).join("g").attr("transform",t=>`rotate(${t.data.x+this.treeStartAngle}) translate(${this.outerRadius+e},0)`).append("rect").attr("y",t=>-n/2).attr("width",t=>l(t[1])-l(t[0])).attr("height",n).attr("x",t=>l(t[0]))})}})}drawBoxPlot(){const h=this;let t=h.layerPlaneData.layerStatistic["box plot"]||[];console.log(t),t.forEach((s,t)=>{if(s.isShowObj.isShow){var l=this.layerDataDict[s.layerDataFlieKey].dataSource;let r=this.layerDataDict[s.layerDataFlieKey].dataIndex,o=l.columns,n=[];this.root.leaves().forEach(l=>{if(r.has(l.data.name)){let a={leafName:l.data.name},e=0;s.layerDataColumnsIndex.forEach(t=>{null==r.get(l.data.name)[o[t]]&&e++,a[o[t]]=r.get(l.data.name)[o[t]]}),e!=s.layerDataColumnsIndex.length&&n.push(a)}}),n.columns=s.layerDataColumnsIndex.map(t=>o[t]),console.log(n);var i=h.getMaxMinValue(n,n.columns),c=s.controlData.canvas["Canvas scale"].width.value,d=d3.scaleLinear().domain([i[0]<0?1.1*i[0]:.9*i[0],i[1]]).range([0,c]),l=d3.scaleOrdinal().range([s.controlData.box["Box style"].fill.value]);let t=n.map(a=>{let e=n.columns.map(t=>a[t]).filter(t=>null!=t);var[t,l,r,o,s]=[0,.25,.5,.75,1].map(t=>d3.quantile(e,t));return{name:a.leafName,min:t,q1:l,m:r,q3:o,max:s,sd:null,dataArr:e}});i=s.controlData.canvas["Canvas scale"].x.value;let a=2*(this.outerRadius+i)*Math.PI/this.root.leaves().length*(1-s.controlData.box["Box style"].padding.value)*this.treeEndAngle/360,e={};this.root.leaves().forEach(t=>{e[t.data.name]=t.x+this.treeStartAngle});c=function(t){return e[t]};c.bandwidth=()=>a,t.innerxScale=c,t.xScale=d,t.colorScale=l,t.boxStyle=s.controlData.box["Box style"],t.pointStyle=s.controlData.point["Point style"],t.significanceStyle=s.controlData.significance,t.translateX=this.outerRadius+i,console.log("9kk",s.categoryColorList);i=this.polarGroup.append("g");this.addAxis(s.controlData,i,d),h.barPlot.drawCircleBox(i,t)}})}drawLinks(){let t=this.layerPlaneData.layerStatistic["link between two nodes"]||[],e=this.figureData.leaves["Leaves Extension"].extension.value,i={};this.root.leaves().forEach(t=>{var a=e?this.outerRadius:t.radius;i[t.data.name]={x:t.x*Math.PI/180,y:a}});let c=d3.lineRadial().curve(d3.curveBundle.beta(.85)).radius(t=>t.y).angle(t=>t.x);console.log(i),t.forEach((s,t)=>{if(s.isShowObj.isShow){let r=this.layerDataDict[s.layerDataFlieKey].dataSource;console.log("9jjj",r),console.log(this.root.leaves());let o=s.controlData.link["Link color"]["color-type"];var a,n=r.filter(t=>{var a=i[t.source]&&i[t.target];return a||console.log("no such link id:",t.id),a}).map(t=>{var a=s.controlData.link["Link style"]["link-type"],e={x:i[t.source].x,y:i[t.source].y},l={x:0,y:0},t={x:i[t.target].x,y:i[t.target].y};if("pure"==o.optionList[o.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value)return"arc"==a.optionList[a.value]?c([e,l,t]):c([e,t]);let r="arc"==a.optionList[a.value]?splitPath(c,[e,l,t]):splitPath(c,[e,t]);return Array.from(r.split(8))});if(console.log("pathData",n),"pure"==o.optionList[o.value]||s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){let l=d3.scaleOrdinal().domain(s.categoryList);return s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value&&(a=s.categoryList.map(t=>s.controlData.link["Color categories"][t].value),console.log(a),l.range(a)),s.colorScale=l,void this.polarGroup.append("g").selectAll("nodelink").data(n).join("path").attr("d",t=>t).attr("fill","none").attr("stroke",(t,a)=>{if(s.controlData.link["Color categories"]&&s.controlData.link["Color categories"].switch.value){var e=r.columns[s.layerDataColumnsIndex[2]];return l(r[a][e])}return s.controlData.link["Link color"].pure.value}).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}n=d3.transpose(n);d3.interpolateRgbBasis(["#ffffff","#ff6668"]);let e=d3.interpolateRgbBasis([s.controlData.link["Link color"].source.value,s.controlData.link["Link color"].target.value]);this.polarGroup.append("g").selectAll("nodelink").data(n).join("path").attr("d",t=>t.join("")).attr("fill","none").attr("stroke",(t,a)=>e(d3.easeQuad(a/255))).call(t=>{this.renderAttr(t,s.controlData.link["Link style"])})}})}drawHeatmap(){const u=this;let t=u.layerPlaneData.layerStatistic.heatmap||[];console.log("heatmap"),console.log(t);let g=this.treeEndAngle/this.root.leaves().length;t.forEach((d,t)=>{if(d.isShowObj.isShow){var h=this.layerDataDict[d.layerDataFlieKey].dataSource;let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,r=h.columns,t=this.root.leaves().filter(t=>l.has(t.data.name)),e=t.map(a=>{let e={};return d.layerDataColumnsIndex.forEach(t=>{e[r[t]]=l.get(a.data.name)[r[t]]}),e});e.columns=d.layerDataColumnsIndex.map(t=>r[t]),console.log(e);h=d.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(e.columns).range([0,h]),o=a.bandwidth(),s=this.polarGroup.append("g").attr("class","heatmapG"),n=u.getMaxMinValue(e,e.columns);h=parseFloat(d.controlData.legend["ColorBar range"]["max-value"].value)||0;h>n[1]&&(n[1]=h);h=parseFloat(d.controlData.legend["ColorBar range"]["min-value"].value)||0;h<n[0]&&(n[0]=h),d.mmv=n;let i=d3.scaleSequential(d.controlData.legend["ColorBar range"].reverse.value?[d.mmv[1],d.mmv[0]]:d.mmv,d3[d.colorInterpolate||"interpolateRdBu"]),c=d.controlData.canvas["Canvas scale"].x.value;s.selectAll(".row").data(this.root.leaves().filter(t=>l.has(t.data.name))).join("g").call((t,a)=>{e.columns.forEach((a,e)=>{t.append("path").attr("d",t=>{let a=d3.arc().innerRadius(e*o+this.maxLength+c).outerRadius((e+1)*o+this.maxLength+c).startAngle((t.x-g/2)*Math.PI/180).endAngle((t.x+g/2)*Math.PI/180);return a()}).attr("fill",t=>d.controlData.cell["Cell style"].notFillZero.value&&0==l.get(t.data.name)[a]?"none":i(l.get(t.data.name)[a])).call(t=>{this.renderAttr(t,d.controlData.cell["Cell style"])}).attr("stroke-width",t=>d.controlData.cell["Cell style"].notFillZero.value&&0==l.get(t.data.name)[a]?0:d.controlData.cell["Cell style"]["stroke-width"].value),d.controlData.cell["Cell text"].switch.value&&t.append("text").attr("transform",t=>`rotate(${t.x-90}) translate(${(e+.5)*o+this.maxLength+c},0)${t.x<180?"":" rotate(180)"}`).text(t=>d.controlData.cell["Cell style"].notFillZero.value&&0==l.get(t.data.name)[a]?"":l.get(t.data.name)[a]).attr("dy","0.35em").attr("text-anchor","middle").call(t=>{this.renderAttr(t,d.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(i(l.get(t.data.name)[a])).l?"#222":"#fff"})})}),d.controlData.xAxis["Text style"]["text-anchor"].value=2,s.selectAll("colText").data(e.columns).join("g").attr("transform",t=>`translate(0,${-(c+this.maxLength+a(t)+o/2)})`).call(t=>{t.append("text").text(t=>t).attr("class",d.controlData.xAxis["Text style"].id).attr("dy",".3em").call(t=>{this.renderAttr(t,d.controlData.xAxis["Text style"])}),d.controlData.xAxis.Tick.removeTick.value||t.append("line").attr("x2",-6).attr("stroke","#000000")})}})}drawBinary2(){let t=this.layerPlaneData.layerStatistic["binary type 2"]||[],d=this.treeEndAngle/this.root.leaves().length;t.forEach((i,t)=>{if(i.isShowObj.isShow){var c=this.layerDataDict[i.layerDataFlieKey].dataSource;let l=this.layerDataDict[i.layerDataFlieKey].dataIndex,r=c.columns,t=this.root.leaves().filter(t=>l.has(t.data.name)),e=t.map(a=>{let e={};return i.layerDataColumnsIndex.forEach(t=>{e[r[t]]=l.get(a.data.name)[r[t]]}),e});e.columns=i.layerDataColumnsIndex.map(t=>r[t]),console.log(e);c=i.controlData.canvas["Canvas scale"].width.value;let a=d3.scaleBand().domain(e.columns).range([0,c]),o=a.bandwidth(),s=this.polarGroup.append("g").attr("class","heatmapG"),n=i.controlData.canvas["Canvas scale"].x.value;s.selectAll(".row").data(this.root.leaves().filter(t=>l.has(t.data.name))).join("g").call((t,a)=>{e.columns.forEach((a,e)=>{t.append("path").attr("d",t=>{let a=d3.arc().innerRadius(e*o+this.maxLength+n).outerRadius((e+1)*o+this.maxLength+n).startAngle((t.x-d/2)*Math.PI/180).endAngle((t.x+d/2)*Math.PI/180);return a()}).attr("class",i.controlData.cell["Cell style"].id).attr("fill-opacity",t=>0==l.get(t.data.name)[a]?.4:1).call(t=>{this.renderAttr(t,i.controlData.cell["Cell style"])}),i.controlData.cell["Cell text"].switch.value&&t.append("text").attr("transform",t=>`rotate(${t.x-90}) translate(${(e+.5)*o+this.maxLength+n},0)${t.x<180?"":" rotate(180)"}`).text(t=>l.get(t.data.name)[a]).attr("dy","0.35em").attr("class",i.controlData.cell["Cell text"].id).attr("text-anchor","middle").call(t=>{this.renderAttr(t,i.controlData.cell["Cell text"])}).attr("fill",t=>{return.5<d3.hsl(i.controlData.cell["Cell style"].fill.value).l?"#222":"#fff"})})}),i.controlData.xAxis["Text style"]["text-anchor"].value=2,s.selectAll("colText").data(e.columns).join("g").attr("transform",t=>`translate(0,${-(n+this.maxLength+a(t)+o/2)})`).call(t=>{t.append("text").text(t=>t).attr("class",i.controlData.xAxis["Text style"].id).attr("dy",".3em").call(t=>{this.renderAttr(t,i.controlData.xAxis["Text style"])}),i.controlData.xAxis.Tick.removeTick.value||t.append("line").attr("x2",-6).attr("stroke","#000000")})}})}drawBinary(){let t=this.layerPlaneData.layerStatistic["binary type 1"]||[];console.log(t),t.forEach((c,t)=>{if(c.isShowObj.isShow){let l=this.layerDataDict[c.layerDataFlieKey].dataIndex,t=this.root.leaves().filter(t=>l.has(t.data.name)),a=t.map(a=>{let e={};return c.categoryList.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});a.columns=c.categoryList,console.log(a);var d=c.controlData.canvas["Canvas scale"].width.value;let e=d3.scaleBand().domain(a.columns).range([0,d]),r=c.controlData.canvas["Canvas scale"].x.value,o=e.bandwidth(),s=2*(r+this.outerRadius)*Math.PI/this.root.leaves().length,n=this.polarGroup.append("g"),i=d3.scaleOrdinal().domain(a.columns).range(0==c.categoryColorList.length?["#cccccc"]:c.categoryColorList);c.controlData.cell["Custom color"].switch.value&&i.range(c.categoryList.map(t=>c.controlData.cell["Custom color"][t].value)),n.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+r},0)`).call((e,t)=>{a.columns.forEach((a,t)=>{e.filter(t=>null!=l.get(t.data.name)[a]).append("circle").attr("cx",(t+.5)*o).attr("r",Math.min(o,s)/2*c.controlData.cell["Cell style"]["size-rate"].value).attr("fill",t=>{return 0==l.get(t.data.name)[a]?"none":i(a)}).attr("stroke",t=>i(a)).attr("class",c.controlData.cell["Cell style"].id).call(t=>{this.renderAttr(t,c.controlData.cell["Cell style"])}).append("title").text(t=>l.get(t.data.name)[a])})}),c.controlData.xAxis["Text style"]["text-anchor"].value=2,n.selectAll("colText").data(a.columns).join("g").attr("transform",t=>`translate(0,${-(r+this.outerRadius+e(t)+o/2)})`).call(t=>{t.append("text").text(t=>t).attr("class",c.controlData.xAxis["Text style"].id).attr("dy",".3em").call(t=>{this.renderAttr(t,c.controlData.xAxis["Text style"])})})}})}drawTextLabel(){let t=this.layerPlaneData.layerStatistic["text map"]||[];console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,a=this.layerDataDict[d.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=d.layerDataColumnsIndex.map(t=>a.columns[t]),e=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});e.columns=r,console.log(e);var h=d.controlData.canvas["Canvas scale"].width.value;let o=d3.scaleBand().domain(e.columns).range([0,h]),s=d.controlData.canvas["Canvas scale"].x.value,n=o.bandwidth();s,this.outerRadius,Math.PI,this.root.leaves().length;let i=this.polarGroup.append("g"),c=d3.scaleOrdinal().domain(e.columns).range(0==d.categoryColorList.length?["#cccccc"]:d.categoryColorList);d.controlData.text["Custom color"].switch.value&&c.range(d.categoryList.map(t=>d.controlData.text["Custom color"][t].value)),i.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+s},0)`).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("g").attr("transform",t=>`translate(${(e+.5)*n},0)${t.x<180?"":" rotate(180)"}`).append("text").attr("dy","0.35em").attr("fill",t=>c(a)).attr("class",d.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,d.controlData.text["Text style"])}).text(t=>l.get(t.data.name)[a])})}),d.controlData.xAxis["Text style"]["text-anchor"].value=2,i.selectAll("colText").data(e.columns).join("g").attr("transform",t=>`translate(0,${-(s+this.outerRadius+o(t)+n/2)})`).call(t=>{t.append("text").text(t=>t).attr("class",d.controlData.xAxis["Text style"].id).attr("dy",".3em").call(t=>{this.renderAttr(t,d.controlData.xAxis["Text style"])})})}})}drawTextLabelCategory(){let t=this.layerPlaneData.layerStatistic["text map with category"]||[];console.log(t),t.forEach((d,t)=>{if(d.isShowObj.isShow){let l=this.layerDataDict[d.layerDataFlieKey].dataIndex,a=this.layerDataDict[d.layerDataFlieKey].dataSource,t=this.root.leaves().filter(t=>l.has(t.data.name)),r=d.layerDataColumnsIndex.map(t=>a.columns[t]),e=t.map(a=>{let e={};return r.forEach(t=>{e[t]=l.get(a.data.name)[t]}),e});e.columns=r.slice(1),console.log(e);var h=d.controlData.canvas["Canvas scale"].width.value;let o=d3.scaleBand().domain(e.columns).range([0,h]),s=d.controlData.canvas["Canvas scale"].x.value,n=o.bandwidth();s,this.outerRadius,Math.PI,this.root.leaves().length;let i=this.polarGroup.append("g"),c=d3.scaleOrdinal().domain(d.categoryList).range(0==d.categoryColorList.length?["#cccccc"]:d.categoryColorList);d.controlData.text["Custom color"].switch.value&&c.range(d.categoryList.map(t=>d.controlData.text["Custom color"][t].value)),d.colorScale=c,i.selectAll(".row").data(t).join("g").attr("transform",t=>`rotate(${t.x+this.treeStartAngle}) translate(${this.outerRadius+s},0)`).call((t,a)=>{e.columns.forEach((a,e)=>{t.filter(t=>null!=l.get(t.data.name)[a]).append("g").attr("transform",t=>`translate(${(e+.5)*n},0)${t.x<180?"":" rotate(180)"}`).append("text").attr("dy","0.35em").attr("fill",t=>c(l.get(t.data.name)[r[0]])).attr("class",d.controlData.text["Text style"].id).call(t=>{this.renderAttr(t,d.controlData.text["Text style"])}).text(t=>l.get(t.data.name)[a])})}),d.controlData.xAxis["Text style"]["text-anchor"].value=2,i.selectAll("colText").data(e.columns).join("g").attr("transform",t=>`translate(0,${-(s+this.outerRadius+o(t)+n/2)})`).call(t=>{t.append("text").text(t=>t).attr("class",d.controlData.xAxis["Text style"].id).attr("dy",".3em").call(t=>{this.renderAttr(t,d.controlData.xAxis["Text style"])})})}})}drawTextBlock(){const o=this;let t=o.layerPlaneData.layerStatistic["color block of leaves name"];t&&t.forEach((u,l)=>{var t=this.layerDataDict[u.layerDataFlieKey].dataSource;let g=this.layerDataDict[u.layerDataFlieKey].dataIndex,p=t.columns[u.layerDataColumnsIndex[0]],r=d3.scaleOrdinal().domain(u.categoryList).range(u.categoryColorList);if(console.log(this.styleData.isUseColorGradient),u.isUseColorGradient&&r.range(d3.quantize(d3[u.colorInterpolate],r.domain().length)),u.controlData.color["Custom color"].switch.value&&r.range(u.categoryList.map(t=>u.controlData.color["Custom color"][t].value)),u.colorScale=r,console.log(u.categoryColorList),u.isShowObj.isShow){let s=[],n=void 0,i=1/0,c=null,d=this.root.leaves(),h=d3.lineRadial().radius(t=>t.radius).angle(t=>t.angle);function m(a,t){return t.every(t=>a.leaves().includes(t))?a:m(a.parent,t)}d.forEach((t,a)=>{let e=g.has(t.data.name)&&g.get(t.data.name)[p]||"";e!=n&&(s.push({name:e.toString(),start:a,end:0,node_arr:[],leafTextEndPositionArr:[]}),0<=s.length-2&&(s[s.length-2].end=a-1,s[s.length-2].LCA=m(c,s[s.length-2].node_arr),s[s.length-2].maxChidrenLength=d3.max(s[s.length-2].node_arr,t=>t.radius),i=t.depth,c=t)),s[s.length-1].node_arr.push(t),console.log(t);var l=[{angle:0,radius:0},{angle:t.middleAngle*Math.PI/180,radius:t.unrootedRadius+u.controlData.block.block.extension.value}];let r=h(l);var o=r.split("L")[1].split(","),l=Number(o[0]),o=Number(o[1]),{x:l,y:o}=this.getAbsolutePosition(t.parent,l,o);s[s.length-1].leafTextEndPositionArr.push([l,o]),t.depth<i&&(i=t.depth,c=t),n=e,a==d.length-1&&(s[s.length-1].end=a,s[s.length-1].LCA=m(c,s[s.length-1].node_arr),s[s.length-1].maxChidrenLength=d3.max(s[s.length-1].node_arr,t=>t.radius))}),console.log("block_data",s),s=s.filter(t=>""!=t.name),this.polarGroup.append("defs").selectAll(".gradient").data(s).join("radialGradient").each(function(t,a){let e=d3.select(this);e.attr("id",t=>`cboln-${t.name.replaceAll("'","-").replaceAll(" ","-").trim()}-${a}-${l}`).attr("cx",t=>t.LCA.absolutePosition.x).attr("cy",t=>t.LCA.absolutePosition.y).attr("r",t=>{let e=0,l=0;t.node_arr.forEach((t,a)=>{t.radius>l&&(e=a,l=t.radius)});var a=t.leafTextEndPositionArr[e],t=t.LCA.absolutePosition;return Math.sqrt(Math.pow(a[0]-t.x,2)+Math.pow(a[1]-t.y,2))}).attr("gradientUnits","userSpaceOnUse"),e.append("stop").attr("offset",t=>{t.LCA.radius,t.LCA.data.length,o.treeScale,t.maxChidrenLength;return.2}).attr("stop-color",t=>r(t.name)).attr("stop-opacity",u.controlData.color["Color gradient"].reverse.value?0:1),e.append("stop").attr("offset",1).attr("stop-color",t=>r(t.name)).attr("stop-opacity",u.controlData.color["Color gradient"].reverse.value?1:0)});let t=this.polarGroup.append("g").lower().selectAll("area").data(s).join("g");t.append("path").attr("d",t=>{var a=u.controlData.block.block["curve-type"],e=a.optionList[a.value];let l=void 0;switch(e){case"curveCatmullRomClosed":l=d3[e].alpha(u.controlData.block.block["curve-tension"].value);break;case"curveCardinalClosed":l=d3[e].tension(u.controlData.block.block["curve-tension"].value);break;case"curveBasisClosed":l=d3[e]}let r=d3.line().x(t=>t[0]).y(t=>t[1]).curve(l),o=hull([[t.LCA.absolutePosition.x,t.LCA.absolutePosition.y],...t.leafTextEndPositionArr],1600);return t.hull=o,o.pop(),console.log(o),r(o)}).call(t=>{u.controlData.color["Color gradient"].switch.value?t.attr("fill",(t,a)=>`url('#cboln-${t.name.replaceAll("'","-").replaceAll(" ","-").trim()}-${a}-${l}')`):t.attr("fill",t=>r(t.name))}),u.controlData.block.text.switch.value&&t.append("g").attr("transform",t=>{let e=0,l=0;t.node_arr.forEach((t,a)=>{t.radius>l&&(e=a,l=t.radius)});var a=t.leafTextEndPositionArr[e],r=(t.node_arr[e].startAngle+t.node_arr[e].endAngle)/2;return t.textAnchor=r<180?"start":"end",`translate(${a[0]},${a[1]})`}).append("text").attr("class",u.controlData.block.text.id).attr("text-anchor",t=>t.textAnchor).attr("x",t=>"start"==t.textAnchor?u.controlData.block.text.x.value:-u.controlData.block.text.x.value).attr("fill",t=>u.controlData.block.text["fill-as-block"].value?r(t.name):u.controlData.block.text.fill.value).text(t=>t.name).call(t=>{this.renderAttr(t,u.controlData.block.text)})}})}addAxis(e,a,l){let r=e.canvas["Canvas scale"].x.value;var o=e.canvas["Canvas scale"].width.value;let t=l.ticks();const s=e.xAxis.Tick;if(s.hasOwnProperty("tickValues")&&s.tickValues.value&&(t=s.tickValues.value.split(",")),e.background.Background.switch.value){let t=d3.arc().innerRadius(r+this.outerRadius).outerRadius(r+this.outerRadius+o).startAngle((this.treeStartAngle+90)*Math.PI/180).endAngle(this.treeEndAngle*Math.PI/180);a.append("path").attr("d",t()).attr("class",e.background.Background.id).call(t=>{this.renderAttr(t,e.background.Background)})}a.selectAll("circleG").data(t).join("g").call(t=>{let a=e.xAxis.Grid;a.switch.value&&t.append("path").attr("d",t=>{let a=d3.path();return a.arc(0,0,l(t)+this.outerRadius+r,this.treeStartAngle*Math.PI/180,(this.treeEndAngle-90)*Math.PI/180),a.toString()}).attr("fill","none").attr("class",a.id).call(t=>this.renderAttr(t,a)),t.append("g").attr("transform",t=>`translate(0,${-l(t)-this.outerRadius-r})`).append("text").attr("dy","0.35em").attr("class",e.xAxis["Text style"].id).text(t=>t).call(t=>{this.renderAttr(t,e.xAxis["Text style"])})})}}window.normalTree=new NormalTree,normalTree.setExampleData(["/static/Ali/data/NJ_tree.treefile"]);let queryParams=new URLSearchParams(window.location.search);if(queryParams.has("originalJsonDataUri")){let t=queryParams.get("originalJsonDataUri");d3.json(t).then(t=>{normalTree.importOriginalJsonData(t),d3.select("#page-loading-box").remove()})}else d3.text("/static/Ali/data/NJ_tree.treefile").then(function(t){normalTree.onLoadNewFile(t),d3.select("#page-loading-box").remove()});